<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Debug Offset Step</title>
		<script src="/demo/debug-offset-step/global/pathseg-polyfill.js"></script>
		<!-- https://sourceforge.net/p/jsclipper/wiki/documentation/ -->
		<script src="/demo/debug-offset-step/global/clipper.js"></script>
		<script src="/demo/debug-offset-step/post-trace-fixtures/example-data.js"></script>
		<script type="module">
			import { regionsFromPathDataString } from "/demo/debug-offset-step/modules/regions-from-path-data-string.js";
			import { svgNodeFromPolygons } from "/demo/debug-offset-step/modules/svg-node-from-polygons.js";
			import { getFallbackViewBox } from "/demo/debug-offset-step/modules/get-fallback-viewbox.js";

			/**
			 * TODO: write description
			 */
			function simplifyRegions(regions) {
				const polygonsClipper = regions.map((region) => {
					return region.map(([X, Y]) => ({ X, Y }));
				});
				const polygonsClipperSimplified = ClipperLib.Clipper.SimplifyPolygons(
					polygonsClipper,
					ClipperLib.PolyFillType.pftNonZero
				);
				const polygonsSimplified = polygonsClipperSimplified.map((region) => {
					return region.map(({ X, Y }) => [X, Y]);
				});
				return polygonsSimplified;
			}

			const offsetAmount = 12;

			// Render each of the examples
			for (const { pathData, viewBox: rawViewBox } of EXAMPLES.slice(0, 2)) {
				const extraPadding = offsetAmount * 2;
				const viewBox = [
					rawViewBox[0] - extraPadding,
					rawViewBox[1] - extraPadding,
					rawViewBox[2] + extraPadding * 2,
					rawViewBox[3] + extraPadding * 2,
				];
				const regions = regionsFromPathDataString(pathData);
				// Render a "before" element, for comparison
				const beforeSvgNode = svgNodeFromPolygons([{ regions }], viewBox, {
					showDebug: true,
					debugColor1: "rgba(255,0,255,0.3)",
					debugColor2: "rgba(255,0,255,0.8)",
				});
				document.body.append(beforeSvgNode);
				// Ensure the region has no self-intersections, using SimplifyPolygon()
				const regionsSimplified = simplifyRegions(regions);
				const simplifiedRegionNode = svgNodeFromPolygons(
					[{ regions: regionsSimplified }],
					viewBox,
					{
						showDebug: true,
						debugColor1: "rgba(255,0,255,0.3)",
						debugColor2: "rgba(128,0,255,0.8)",
					}
				);
				document.body.append(simplifiedRegionNode);

				/**
				 * TODO: describe why this is needed...
				 * ie Clipper wants integer co-ordinates, we scale up to avoid
				 * losing too much precision in rounding.
				 */
				const preClipperScale = 10;
				const regionsSimplifiedClipper = regionsSimplified.map((region) => {
					return region.map(([X, Y]) => ({
						X: Math.round(X * 10),
						Y: Math.round(Y * 10),
					}));
				});

				/**
				 * TODO: below is roughed in from:
				 * https://sourceforge.net/p/jsclipper/wiki/documentation/#clipperlibclipperoffsetexecute
				 */

				const arcTolerance = 125;
				const miterLimit = 2;
				var subjectClipper = new ClipperLib.Paths();
				var solutionClipper = new ClipperLib.Paths();
				/**
				 * TODO: handle multiple regions!
				 */
				subjectClipper[0] = regionsSimplifiedClipper[0].slice(0);
				const clipperOffsetScale = 100;
				ClipperLib.JS.ScaleUpPaths(subjectClipper, clipperOffsetScale);
				const clipperOffset = new ClipperLib.ClipperOffset(
					miterLimit,
					arcTolerance
				);
				clipperOffset.AddPaths(
					subjectClipper,
					ClipperLib.JoinType.jtRound,
					ClipperLib.EndType.etClosedPolygon
				);
				clipperOffset.Execute(
					solutionClipper,
					offsetAmount * clipperOffsetScale * preClipperScale
				);
				ClipperLib.JS.ScaleDownPaths(
					solutionClipper,
					clipperOffsetScale * preClipperScale
				);
				const solutionRegions = solutionClipper.map((regionClipper) => {
					return regionClipper.map(({ X, Y }) => [X, Y]);
				});
				const solutionPolygon = { regions: solutionRegions };
				const solutionViewBox = getFallbackViewBox([solutionPolygon], 10);
				const demoSolutionNode = svgNodeFromPolygons(
					[solutionPolygon],
					// solutionViewBox,
					viewBox,
					{
						showDebug: true,
						debugColor1: "rgba(255,0,255,0.3)",
						debugColor2: "rgba(0,0,255,0.8)",
					}
				);
				document.body.append(demoSolutionNode);

				document.body.append(document.createElement("hr"));
			}
		</script>
	</head>
	<body></body>
</html>
