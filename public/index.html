<!DOCTYPE html>
<html>
	<head>
		<!-- GLOBAL -->
		<script src="/modules/03-trace/flatten-svg/path-data-polyfill.js"></script>
		<script src="/modules/global/clipper.js"></script>
		<script src="/modules/global/pathseg-polyfill.js"></script>
		<!-- COMMON -->
		<script src="/modules/00-common/copy-text-to-clipboard.js"></script>
		<!-- SILHOUETTE - could try to figure out how to include as a module? -->
		<script src="/modules/02-silhouette/image.min.js"></script>
		<!-- TRACE - could try to figure out how to include as a module? -->
		<script src="/modules/03-trace/imagetracer_v1.2.6.js"></script>
		<!-- TRACE CLEANUP -->
		<script src="/modules/03-trace/flatten-svg/svg-to-paths.js"></script>
		<!-- OFFSET -->
		<script src="/modules/04-offset/bezier.js"></script>
		<script src="/modules/04-offset/browser.maker.js"></script>
		<script src="/modules/04-offset/flatten-svg-to-paths.js"></script>
		<!-- ARRANGE -->
		<script src="/modules/05-arrange/create-circular-polygon.js"></script>
		<!-- UNION -->
		<script src="/modules/06-union/polybooljs-1.2.2/dist/polybool.js"></script>
		<!-- main module -->
		<script type="module" src="/modules/main.js"></script>
		<!-- main execution -->
		<script>
			/**
			 * TODO: refactor so runAll() can start from specific step.
			 * Eg, when adjusting `offset`, should re-run from `applyOffset()`
			 * onwards, everything before is already done.
			 *
			 * In fact, there'd even be sub-steps. Eg, when adjusting the "offset"
			 * in the "arrange" phase, really only need to re-run PART of a step.
			 * That level of optimization could come later... but may be worth
			 * thinking through, when you're deciding exactly HOW to refactor.
			 * Maybe the answer is just... if you want to break a single step
			 * down into two parts, then maybe that step should really be two steps.
			 * And for the "arrange" step at least, seems totally fine to do a little
			 * extra redundant math WITHIN the step... it'll be wasteful but
			 * fast anyways.
			 */
			async function runAll() {
				const imgResizeMax = 400;
				const {
					width: widthSilhouette,
					height: heightSilhouette,
					widthOriginal,
					heightOriginal,
					scaleFactor: scaleBeforeSilhouette,
					paddingBeforeTrace,
				} = await silhouetteExecute(
					"raw-image",
					"processed-image",
					imgResizeMax
				);
				const cleanTracePolygons = await traceExecute(
					"processed-image",
					"trace-svg"
				);
				const svgSourceContainer = document.getElementById("trace-svg");
				const svgSource = svgSourceContainer.querySelector("svg");
				const [polygons_offset, offset] = applyOffset(
					"trace-svg",
					"offset-svg",
					cleanTracePolygons
				);
				const {
					polygons_arranged,
					scale,
					baseSize,
					baseOverlap,
					boundingWidth,
					boundingHeight,
					boundingBox,
					arrangeOffset,
					reflectedPolygonOffsetY,
					baseCenters,
				} = arrangeForUnion(
					polygons_offset,
					document.getElementById("arrange-container")
				);
				const polygons_union = applyUnion(
					polygons_arranged,
					"union-container"
					// "union-shapes-debug",
					// "union-arrange-debug"
				);
				// TODO: grab polygon width and height, probs from "arrange for union"
				await applyLayout(
					polygons_union,
					{
						scale,
						scaleBeforeSilhouette,
						imgResizeMax,
						paddingBeforeTrace,
						widthSilhouette,
						heightSilhouette,
						widthOriginal,
						heightOriginal,
						arrangeOffset,
						boundingHeight,
						boundingWidth,
						boundingBox,
						baseSize,
						baseOverlap,
						baseCenters,
						reflectedPolygonOffsetY,
					},
					"layout-container"
				);
			}

			async function resetAndRunAll() {
				resetSettings();
				await runAll();
			}
		</script>
		<style>
			body {
				display: flex;
				flex-direction: column;
				align-items: center;
			}

			.raw-image-container {
				width: 400px;
				height: 400px;
			}

			.raw-image-container img {
				width: 100%;
				height: 100%;
				object-fit: contain;
			}

			.processed-image-container {
				width: 450px;
				height: 450px;
				display: flex;
				align-items: center;
				justify-content: center;
			}

			.note {
				font-style: italic;
				max-width: 30em;
				margin: 0 auto;
				text-align: center;
			}
		</style>
		<script>
			function updateImage(newImageSrc, settings = {}) {
				const rawImageElement = document.getElementById("raw-image");
				rawImageElement.src = newImageSrc;
				rawImageElement.onload = async () => {
					// Update settings
					// console.log({ settings });
					for (const [key, value] of Object.entries(settings)) {
						document.getElementById(key).value = value;
					}
					await runAll();
				};
			}
		</script>
	</head>
	<body
		onload="updateImage('/sample-art/sample-char-art-00.jpeg', {
		heightMm: 30,
		radius: 2,
		arrangeOffsetX: -5
	})"
	>
		<h1>Paper Miniature Generator</h1>
		<div
			style="
				max-width: 30em;
				padding: 2em;
				border: 1px solid magenta;
				border-radius: 8px;
			"
		>
			<p style="color: magenta; font-weight: bold; text-align: center">
				PLEASE NOTE
			</p>
			<p>
				This tool is a rough work in progress. This tool works with images that
				meet the following criteria:
			</p>
			<ul>
				<li>
					Images SHOULD have a blank white background. This is helpful for
					tracing, and also prints nicely. If you need a way to remove a
					background,
					<a href="https://www.remove.bg/">https://www.remove.bg/</a> works
					well, the small image sizes you get for free are great for minis.
				</li>
				<!-- <li>
					MUST be a JPEG. If you have a PNG, you can use whatever tool you're
					most familiar with on your computer, or a quick online tool like
					<a href="https://convertio.co/png-jpeg/">Convertio</a>.
				</li> -->
				<li>
					Images SHOULD be under 1000 pixels square, so file sizes aren't too
					large. If you need an online image resizing tool, many have annoying
					ads, but
					<a href="https://www.adobe.com/express/feature/image/resize"
						>Adobe Express's resize tool</a
					>
					can be refreshing because it's just one giant ad for Adobe.
				</li>
			</ul>
			<p>
				EVEN IF you have an image that perfectly meets all these criteria, you
				will may want or even need to twiddle some knobs to get this tool to
				work how you expect. Thanks for your patience!
			</p>
		</div>

		<!--  -->
		<!--  -->
		<!--  -->
		<h2>UPLOAD</h2>
		<!--  -->
		<!--  -->
		<!--  -->

		<p>
			<input
				type="file"
				id="image-input"
				accept="image/png, image/jpeg"
				onchange="onImageSelection(this, 'raw-image', resetAndRunAll)"
			/>
		</p>

		<p>Or choose an example:</p>

		<p>
			<button
				onclick="updateImage('/sample-art/sample-char-art-00.jpeg', {
				heightMm: 30,
				radius: 2,
				arrangeOffsetX: -5,
				offset: 5
			})"
			>
				sample-char-art-00.jpeg
			</button>
			<button
				onclick="updateImage('/sample-art/sample-char-art-01.jpeg', { heightMm: 35, radius: 2, arrangeOffsetX: -5, offset: 30 })"
			>
				sample-char-art-01.jpeg
			</button>
			<button
				onclick="updateImage('/sample-art/sample-char-art-02.jpeg', { heightMm: 25, radius: 2, arrangeOffsetX: 0, offset: 30 })"
			>
				sample-char-art-02.jpeg
			</button>
			<button
				onclick="updateImage('/sample-art/sample-char-art-03.jpeg', { heightMm: 35, radius: 3, arrangeOffsetX: 0, offset: 30 })"
			>
				sample-char-art-03.jpeg
			</button>
			<button
				onclick="updateImage('/sample-art/sample-char-art-transparent-04.png', { heightMm: 35, radius: 3, arrangeOffsetX: 0, offset: 30 })"
			>
				sample-char-art-transparent-04.png
			</button>
		</p>

		<!--  -->
		<!--  -->
		<!--  -->
		<h2>SILHOUETTE</h2>
		<!--  -->
		<!--  -->
		<!--  -->

		<p class="note">
			NOTE: it may take a minute for image processing to run and update the
			silhouette image.
		</p>
		<div style="height: 1em"></div>
		<div style="display: flex; align-items: center">
			<div class="raw-image-container">
				<img id="raw-image" src="/sample-art/sample-char-art-00.jpeg" />
			</div>
			<div class="processed-image-container">
				<img id="processed-image" />
			</div>
		</div>

		<h3>Silhouette tweaks</h3>
		<p>
			Threshold (0-255)
			<input id="threshold" type="number" min="0" max="255" value="200" />
		</p>
		<p>
			Blur radius
			<input
				onchange="runAll()"
				id="radius"
				type="number"
				min="1"
				max="30"
				value="2"
			/>
		</p>
		<p>
			<button onClick="runAll()">Apply silhouette tweaks</button>
		</p>

		<!--  -->
		<!--  -->
		<!--  -->
		<h2>TRACE</h2>
		<!--  -->
		<!--  -->
		<!--  -->

		<p class="note">
			NOTE: image tracing can take a bit of time. But it should run pretty
			reliably though.
		</p>
		<div id="trace-svg"></div>
		<h3>Trace tweaks</h3>
		<p>
			Omit shapes with an area less than:
			<input id="pathomit" type="number" min="0" value="30" />
		</p>
		<p>
			<button onClick="runAll()">Apply trace tweaks</button>
		</p>

		<!--  -->
		<!--  -->
		<!--  -->
		<h2>OFFSET</h2>
		<!--  -->
		<!--  -->
		<!--  -->

		<!-- <p class="note" style="color: magenta">
			NOTE: sometimes (... quite often actually), the "offset" step fails! I'm
			still trying to figure out the root cause and fix it... but for now, first
			tweak the "threshold" value to make sure you have a good silhouette. If
			the silhouette already looks good, then try twiddling the "blur radius"
			input by one unit up or down in the silhouette step seems to help.
		</p> -->
		<div id="offset-svg"></div>
		<h3>Offset tweaks</h3>
		<p>
			Offset amount:
			<input id="offset" type="number" min="0" max="100" value="30" />
		</p>
		<button onClick="runAll()">Apply offset tweaks</button>

		<!--  -->
		<!--  -->
		<!--  -->
		<h2>ARRANGE</h2>
		<!--  -->
		<!--  -->
		<!--  -->

		<div id="arrange-container"></div>
		<h3>Arrangement tweaks</h3>
		<p>
			Base size in mm (1 inch ~= 25 mm)
			<input id="baseSizeMm" type="number" min="12" max="50" value="25" />
		</p>

		<p>
			Height in mm (1 inch ~= 25 mm)
			<input id="heightMm" type="number" min="5" max="100" value="35" />
		</p>
		<p>
			X offset (use to center the image over the base)
			<input id="arrangeOffsetX" type="number" min="-100" max="100" value="0" />
		</p>
		<p>
			Y offset (use to "float" or "ground" the image)
			<!-- TODO: max should be based on "base size". For now, have done
			     base size (72) divided by 4 -->
			<input id="arrangeOffsetY" type="number" min="0" max="18" value="0" />
		</p>
		<button onClick="runAll()">Apply arrangement tweaks</button>

		<!--  -->
		<!--  -->
		<!--  -->
		<h2>UNION</h2>
		<!--  -->
		<!--  -->
		<!--  -->
		<div id="union-shapes-debug"></div>
		<div id="union-arrange-debug"></div>
		<div id="union-container"></div>

		<!--  -->
		<!--  -->
		<!--  -->
		<h2>LAYOUT</h2>
		<!--  -->
		<!--  -->
		<!--  -->

		<div id="layout-container"></div>
		<button
			onClick="copyTextToClipboard(document.getElementById('layout-container').innerHTML)"
		>
			Copy SVG to clipboard
		</button>
		<div style="height: 3em"></div>
		<div
			style="
				max-width: 30em;
				padding: 2em;
				border: 1px solid magenta;
				border-radius: 8px;
			"
		>
			<p style="color: magenta; font-weight: bold; text-align: center">
				WHAT NEXT?
			</p>
			<p>
				You probably want to print the SVG above somehow! You'll need a tool
				that lets you paste an SVG from your clipboard, and arrange it on a
				page. You can usually fit many different miniatures on a single page.
			</p>
			<p>
				<a href="https://www.figma.com/">Figma</a> is likely the easiest option
				if you're unfamiliar. <a href="https://inkscape.org/">Inkscape</a> is
				another option, it's a free and open-source vector graphics editor but
				might have a bit more of a learning curve.
			</p>
		</div>

		<div style="height: 16em"></div>
	</body>
</html>
