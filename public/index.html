<!DOCTYPE html>
<html>
	<head>
		<title>Paper Mini Gen</title>
		<link rel="shortcut icon" href="#" />
		<script type="text/javascript" src="/lib/imagetracer_v1.2.6.js"></script>
		<script type="text/javascript" src="/lib/dat.gui.min.js"></script>
		<script type="text/javascript" src="/lib/pathseg.js"></script>
		<script type="text/javascript" src="/lib/path-to-polygon.js"></script>
		<!-- https://www.lactame.com/lib/image-js/0.21.2/image.min.js -->
		<script type="text/javascript" src="/lib/image.min.js"></script>
		<script type="text/javascript" src="/lib/get-input-as-int.js"></script>
		<script type="text/javascript" src="/lib/apply-threshold.js"></script>
	</head>
	<body>
		<!--  -->
		<!--  -->
		<!--  -->
		<h2>IMAGE UPLOAD</h2>
		<!--  -->
		<!--  -->
		<!--  -->

		<p>
			<input type="file" id="image-input" accept="image/png, image/jpeg" />
		</p>
		<p>
			<img id="image-preview" src="/sample-char-art-00.jpeg" />
		</p>
		<script>
			function onImageSelection(input) {
				if (input.files && input.files[0]) {
					var reader = new FileReader();
					reader.onload = function (e) {
						document
							.getElementById("image-preview")
							.setAttribute("src", e.target.result);
					};
					reader.readAsDataURL(input.files[0]);
				}
			}
		</script>

		<!--  -->
		<!--  -->
		<!--  -->
		<h2>IMAGE SILHOUETTING</h2>
		<!--  -->
		<!--  -->
		<!--  -->
		<script>
			async function processImage() {
				// Load the original raw image from a source element
				const imgElem = document.getElementById("image-preview");
				// Gather optional settings
				const threshold = getInputAsInt("threshold") / 100;
				const radius = getInputAsInt("radius");
				// Proces the image
				const processedSrc = await applyThreshold(
					imgElem.src,
					threshold,
					radius
				);
				// Load the image into a destination element
				document.getElementById("processed-image").src = processedSrc;
			}
		</script>

		<p>
			Threshold
			<input id="threshold" type="number" min="0" max="100" value="50" />
		</p>
		<p>
			Radius
			<input id="radius" type="number" min="1" max="100" value="1" />
		</p>
		<p><button onClick="processImage()">Process image</button></p>
		<img id="processed-image" />

		<!--  -->
		<!--  -->
		<!--  -->
		<h2>IMAGE TRACING</h2>
		<!--  -->
		<!--  -->
		<!--  -->

		<script>
			function traceImage() {
				// NOTE: uses https://github.com/jankovicsandras/imagetracerjs
				const pathomit = getInputAsInt("pathomit");
				const ltres = getInputAsInt("ltres");
				const qtres = getInputAsInt("qtres");
				// Adding custom palette. This will override numberofcolors.
				const options = {
					pathomit,
					ltres,
					qtres,
					colorsampling: 0,
					colorquantcycles: 1,
					strokewidth: 0,
					roundcoords: 2,
					/**
					 * Set a custom palette, of:
					 * - black (foreground shapes)
					 * - nearly-white (background shapes, will remove in later step)
					 */
					pal: [
						{ r: 0, g: 0, b: 0, a: 255 },
						{ r: 245, g: 245, b: 245, a: 255 },
					],
				};
				// Loading an image, tracing with the 'posterized2' option preset, and appending the SVG to an element with id="svgcontainer"
				const imageSource = document
					.getElementById("processed-image")
					.getAttribute("src");
				/**
				 * TODO: is there a way to trace with straight lines only?
				 * Could simplify the process dramatically...
				 */
				ImageTracer.imageToSVG(
					imageSource /* input filename / URL */,
					function (svgstr) {
						document.getElementById("svgcontainer").innerHTML = "";
						ImageTracer.appendSVGString(svgstr, "svgcontainer");
					} /* callback function to run on SVG string result */,
					options
				);
			}
		</script>

		<p><button onClick="traceImage()">Trace Image</button></p>
		<p>OPTIONS</p>
		<p>Path omit: <input id="pathomit" type="number" min="0" value="30" /></p>
		<p>
			Line error threshold:
			<input id="ltres" type="number" min="1" value="2" />
		</p>
		<p>
			Quadratic split error threshold:
			<input id="qtres" type="number" min="1" value="2" />
		</p>
		<div id="svgcontainer"></div>

		<script>
			function cleanupTrace() {
				/**
				 * Clone the SVG generated at the previous step
				 */
				const cleanedTraceContainer = document.getElementById(
					"svgcontainer_polygon"
				);
				cleanedTraceContainer.innerHTML =
					document.getElementById("svgcontainer").innerHTML;
				/**
				 * Retain only the "foreground" paths.
				 *
				 * We only want to outline and boolean add the traced paths
				 * that are "foreground" (ie black). Speficially, remove paths with
				 * `fill="rgb(245,245,245)"`. Note this specific colour was set
				 * in the palette of the trace in an earlier step.
				 */
				cleanedTraceContainer
					.querySelectorAll(`path[fill="rgb(245,245,245)"]`)
					.forEach((e) => e.remove());

				/**
				 * Convert the foreground paths, which may include curves,
				 * to polygons, which will consist of straigh lines only.
				 *
				 * The current approach is swiped from:
				 * https://betravis.github.io/shape-tools/path-to-polygon/
				 *
				 * That being said, it doesn't seem to do _any_ sampling along
				 * curves... instead it only keeps the control points. Maybe
				 * it'd be possible to improve the tracing further by combining
				 * the "retain all control points" approach with a
				 * "sample along the line" approach... perhaps sampling along
				 * the line only for curved segments? This is a deep dive though,
				 * and certainly not something I intend to try to tackle at this time.
				 * More the sample-along-the-line approach:
				 * https://phrogz.net/SVG/convert_path_to_polygon.xhtml
				 * And there's a very naive implementation in:
				 * `basic-point-at-length.html` (in this repo)
				 */
				const polylinesamplefrequency = parseInt(
					document.getElementById("polylinesamplefrequency").value
				);
				convertPathsToPolygon(cleanedTraceContainer.querySelector("svg"));
			}
		</script>

		<h2>CLEANUP TRACE</h2>
		<ul>
			<li>Retain "foreground" elements only</li>
			<li>Convert curves lines to straight lines</li>
		</ul>
		<p><button onClick="cleanupTrace()">cleanupTrace()</button></p>
		<div id="svgcontainer_polygon"></div>

		<h2 style="color: magenta">~~~WIP BELOW~~~</h2>
		<h2 style="color: magenta">OFFSET PATH & BOOLEAN ADDITION</h2>

		<script>
			/**
			 * TODO: look into path offset (not stroke?)
			 * This looks promising: https://danmarshall.github.io/svg-path-outline/
			 */

			/**
			 * TODO: look into boolean operations
			 * Likely need to convert SVG paths to polygons first...
			 * Once that's done...
			 * Potentially useful library for boolean operations on the SVG:
			 * https://github.com/junmer/clipper-lib?tab=readme-ov-file
			 */
		</script>

		<p style="color: magenta">
			TODO: haven't started on this, but hopefully will be relatively smooth
			since we have a polygon with straight lines and points!
		</p>
	</body>
</html>
