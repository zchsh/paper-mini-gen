<!DOCTYPE html>
<html>
	<head>
		<!-- COMMON -->
		<script src="/js-modules/modules/00-common/render-polygons-as-path-svg.js"></script>
		<script src="/js-modules/modules/00-common/get-bounding-points.js"></script>
		<script src="/js-modules/modules/00-common/copy-text-to-clipboard.js"></script>
		<!-- SILHOUETTE - could try to figure out how to include as a module? -->
		<script src="/js-modules/modules/02-silhouette/image.min.js"></script>
		<!-- TRACE - could try to figure out how to include as a module? -->
		<script src="/js-modules/modules/03-trace/imagetracer_v1.2.6.js"></script>
		<!-- TRACE CLEANUP -->
		<script src="/js-modules/modules/03-trace/flatten-svg/path-data-polyfill.js"></script>
		<!-- TODO: the TRACE CLEANUP scripts below this comment could be modules -->
		<script src="/js-modules/modules/03-trace/flatten-svg/svg-to-paths.js"></script>
		<!-- OFFSET -->
		<script src="/js-modules/modules/04-offset/browser.maker.js"></script>
		<script src="/js-modules/modules/04-offset/svg-path-outline.js"></script>
		<script src="/js-modules/modules/04-offset/apply-offset.js"></script>
		<script src="/js-modules/modules/04-offset/flatten-svg-to-paths.js"></script>
		<script src="/js-modules/modules/04-offset/parse-svg-viewbox.js"></script>
		<!-- ARRANGE -->
		<script src="/js-modules/modules/05-arrange/create-circular-polygon.js"></script>
		<!-- UNION -->
		<script src="/js-modules/modules/06-union/polybooljs-1.2.2/dist/polybool.js"></script>
		<!-- main module -->
		<script type="module" src="/js-modules/main.js"></script>
		<!-- main execution -->
		<script>
			/**
			 * TODO: refactor so runAll() can start from specific step.
			 * Eg, when adjusting `offset`, should re-run from `applyOffset()`
			 * onwards, everything before is already done.
			 *
			 * In fact, there'd even be sub-steps. Eg, when adjusting the "offset"
			 * in the "arrange" phase, really only need to re-run PART of a step.
			 * That level of optimization could come later... but may be worth
			 * thinking through, when you're deciding exactly HOW to refactor.
			 * Maybe the answer is just... if you want to break a single step
			 * down into two parts, then maybe that step should really be two steps.
			 * And for the "arrange" step at least, seems totally fine to do a little
			 * extra redundant math WITHIN the step... it'll be wasteful but
			 * fast anyways.
			 */
			async function runAll() {
				const [paddingBeforeTrace, imgWidth, imgHeight] =
					await silhouetteExecute("raw-image", "processed-image");
				const result = await traceExecute("processed-image", "trace-svg");

				const svgSourceContainer = document.getElementById("trace-svg");
				const svgSource = svgSourceContainer.querySelector("svg");
				const [polygons_offset, offset] = applyOffset(
					"trace-svg",
					"offset-svg"
				);
				const [
					polygons_arranged,
					scale,
					baseSize,
					baseOverlap,
					boundingWidth,
					boundingHeight,
				] = arrangeForUnion(
					polygons_offset,
					document.getElementById("arrange-container")
				);
				const polygons_union = applyUnion(polygons_arranged, "union-container");
				// TODO: grab polygon width and height, probs from "arrange for union"
				await applyLayout(
					polygons_union,
					{
						scale,
						paddingBeforeTrace,
						imgWidth,
						imgHeight,
						boundingHeight,
						boundingWidth,
						baseSize,
						baseOverlap,
					},
					"layout-container"
				);
			}

			async function resetAndRunAll() {
				silhouetteResetSettings();
				await runAll();
			}
		</script>
	</head>
	<body onload="resetAndRunAll()">
		<!--  -->
		<!--  -->
		<!--  -->
		<h2>UPLOAD</h2>
		<!--  -->
		<!--  -->
		<!--  -->

		<p>
			<input
				type="file"
				id="image-input"
				accept="image/png, image/jpeg"
				onchange="onImageSelection(this, 'raw-image', resetAndRunAll)"
			/>
		</p>

		<!--  -->
		<!--  -->
		<!--  -->
		<h2>SILHOUETTE</h2>
		<!--  -->
		<!--  -->
		<!--  -->

		<div style="display: flex; align-items: center">
			<img id="raw-image" src="/sample-char-art-00.jpeg" />
			<img id="processed-image" />
		</div>

		<h3>Silhouette tweaks</h3>
		<p>
			Threshold (100 means auto)
			<input id="threshold" type="number" min="0" max="100" value="100" />
		</p>
		<p>
			Radius
			<input id="radius" type="number" min="1" max="100" value="5" />
		</p>
		<p>
			<button onClick="runAll()">Apply silhouette tweaks</button>
		</p>

		<!--  -->
		<!--  -->
		<!--  -->
		<h2>TRACE</h2>
		<!--  -->
		<!--  -->
		<!--  -->

		<div id="trace-svg"></div>
		<h3>Trace tweaks</h3>
		<p>Path omit: <input id="pathomit" type="number" min="0" value="30" /></p>
		<p>
			<button onClick="runAll()">Apply trace tweaks</button>
		</p>

		<!--  -->
		<!--  -->
		<!--  -->
		<h2>OFFSET</h2>
		<!--  -->
		<!--  -->
		<!--  -->

		<div id="offset-svg"></div>
		<h3>Trace tweaks</h3>
		<p>
			Offset:
			<input id="offset" type="number" min="0" max="100" value="30" />
		</p>
		<button onClick="runAll()">Apply offset tweaks</button>

		<!--  -->
		<!--  -->
		<!--  -->
		<h2>ARRANGE</h2>
		<!--  -->
		<!--  -->
		<!--  -->

		<div id="arrange-container"></div>
		<h3>Arrangement tweaks</h3>
		<p>
			Height in mm (1 inch ~= 25 mm)
			<input id="heightMm" type="number" min="5" max="100" value="35" />
		</p>
		<p>
			X offset in pixels ("center")
			<input id="arrangeOffsetX" type="number" min="-100" max="100" value="0" />
		</p>
		<p>
			Y offset in pixels ("float")
			<!-- TODO: max should be based on "base size". For now, have done
			     base size (72) divided by 4 -->
			<input id="arrangeOffsetY" type="number" min="0" max="18" value="0" />
		</p>
		<button onClick="runAll()">Apply arrangement tweaks</button>

		<!--  -->
		<!--  -->
		<!--  -->
		<h2>UNION</h2>
		<!--  -->
		<!--  -->
		<!--  -->
		<!-- <div id="union-shapes-debug"></div> -->
		<!-- <div id="union-arrange-debug"></div> -->
		<div id="union-container"></div>

		<!--  -->
		<!--  -->
		<!--  -->
		<h2 style="color: magenta">LAYOUT</h2>
		<!--  -->
		<!--  -->
		<!--  -->

		<div id="layout-container"></div>
		<h3>Layout tweaks</h3>
		<ul style="color: magenta">
			<li style="color: black">
				embed single original image in the copy-able SVG, any location
			</li>
			<li style="color: black">add reflected original image</li>
			<li style="color: black">
				adjust positioning of embedded original images
			</li>
			<li style="color: magenta">add clip path for top image</li>
			<li style="color: magenta">add clip path for bottom image</li>
			<li style="color: magenta">add white background using clip-path shape</li>
			<li>
				TODO: test with more complex shapes, eg with "holes". have noticed
				sometimes "offset" fails, eg for "sample-char-art-01-small", need to
				investigate why. larger blur radius seems to help... maybe has to do
				with path complexity? maybe path smoothing could be applied immediately
				after the trace step? it does seem like path smoothing would be a nice
				addition.
			</li>
			<li>TODO: clean up styles of union shape, for cutting outline</li>
			<li>TODO: add dotted lines</li>
		</ul>
		<button
			onClick="copyTextToClipboard(document.getElementById('layout-container').innerHTML)"
		>
			Copy Layout SVG to clipboard
		</button>
		<button onClick="runAll()">Apply layout tweaks</button>
	</body>
</html>
